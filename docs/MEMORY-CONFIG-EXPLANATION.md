# 3DPass区块监控系统 - 内存配置详解

## 🔍 内存配置层次关系

### 三层内存保护机制

```
┌─────────────────────────────────────────────────────────────┐
│                    应用内存守护进程                          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                PM2进程管理器                           │ │
│  │  ┌─────────────────────────────────────────────────┐   │ │
│  │  │            Node.js V8引擎                       │   │ │
│  │  │         (--max-old-space-size)                  │   │ │
│  │  └─────────────────────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 1. Node.js堆内存限制 (最内层)
- **参数**: `--max-old-space-size=XXX`
- **作用**: 限制V8引擎的堆内存使用
- **触发**: 堆内存达到限制时，V8会尝试垃圾回收
- **优先级**: 最高，进程启动时确定

### 2. PM2进程管理器 (中间层)
- **参数**: `max_memory_restart: "XXXM"`
- **作用**: 监控整个进程的RSS内存使用
- **触发**: RSS内存达到限制时，PM2重启进程
- **优先级**: 中等，进程运行中监控

### 3. 应用内存守护进程 (最外层)
- **参数**: `MEMORY_CONFIG` 环境变量
- **作用**: 应用内部内存监控和垃圾回收
- **触发**: 内存使用达到阈值时，触发GC或重启
- **优先级**: 最低，应用内部逻辑

## ⚙️ 配置策略

### 内存限制比例
```
Node.js堆内存 = PM2重启限制 × 80%
应用内存限制 = PM2重启限制 × 100%
```

### 为什么使用80%缓冲？
1. **预留空间**: 为V8引擎的垃圾回收预留20%空间
2. **避免冲突**: 确保Node.js堆内存限制先于PM2重启限制触发
3. **平滑过渡**: 给垃圾回收足够时间释放内存

## 📊 各配置规格对比

### 1G内存服务器
| 组件 | PM2重启限制 | Node.js堆内存 | 应用内存限制 |
|------|-------------|---------------|--------------|
| 后端 | 200MB | 160MB (80%) | 200MB |
| Web | 100MB | 80MB (80%) | 100MB |

### 2G内存服务器
| 组件 | PM2重启限制 | Node.js堆内存 | 应用内存限制 |
|------|-------------|---------------|--------------|
| 后端 | 400MB | 320MB (80%) | 400MB |
| Web | 200MB | 160MB (80%) | 200MB |

### 4G内存服务器
| 组件 | PM2重启限制 | Node.js堆内存 | 应用内存限制 |
|------|-------------|---------------|--------------|
| 后端 | 800MB | 640MB (80%) | 800MB |
| Web | 400MB | 320MB (80%) | 400MB |

### 8G内存服务器
| 组件 | PM2重启限制 | Node.js堆内存 | 应用内存限制 |
|------|-------------|---------------|--------------|
| 后端 | 1600MB | 1280MB (80%) | 1600MB |
| Web | 800MB | 640MB (80%) | 800MB |

## 🔄 内存保护流程

### 正常情况
1. **应用启动**: 使用Node.js堆内存限制启动
2. **内存增长**: 随着数据处理，内存使用增加
3. **垃圾回收**: 堆内存达到80%时，V8自动触发GC
4. **内存释放**: GC释放不再使用的内存

### 内存压力情况
1. **堆内存接近限制**: V8频繁触发垃圾回收
2. **RSS内存增长**: 整个进程内存使用增加
3. **PM2监控**: 检测到RSS内存接近重启限制
4. **应用守护**: 应用内部也检测到内存压力
5. **进程重启**: PM2或应用守护触发进程重启

### 内存泄漏情况
1. **持续增长**: 即使GC也无法释放内存
2. **达到限制**: 堆内存或RSS内存达到限制
3. **强制重启**: 系统强制重启进程，释放所有内存

## 🛠️ 配置验证

### 检查当前配置
```bash
# 查看当前内存配置
node check-memory.js

# 查看PM2配置
cat ecosystem.config.js

# 查看内存使用情况
pm2 monit
```

### 测试内存限制
```bash
# 启动内存监控
node memory-guard.js monitor

# 查看内存状态
node memory-guard.js status

# 强制垃圾回收
node memory-guard.js gc
```

## ⚠️ 注意事项

### 1. 配置一致性
- 确保所有内存限制配置一致
- Node.js堆内存 < PM2重启限制
- 应用内存限制 = PM2重启限制

### 2. 监控重要性
- 定期检查内存使用情况
- 关注内存增长趋势
- 及时调整配置参数

### 3. 性能影响
- 较小的堆内存限制可能影响性能
- 频繁的垃圾回收会增加CPU使用
- 需要平衡内存使用和性能

## 🔧 故障排除

### 内存使用过高
1. 检查配置是否合适
2. 查看是否有内存泄漏
3. 考虑增加内存限制

### 频繁重启
1. 检查内存限制是否过小
2. 查看应用日志
3. 调整垃圾回收参数

### 性能问题
1. 检查堆内存限制是否过小
2. 调整GC参数
3. 优化应用代码

## 📈 优化建议

### 1G内存服务器
- 使用最小配置
- 禁用非必要功能
- 减小批处理大小

### 2G内存服务器
- 使用平衡配置
- 启用基础功能
- 适中的批处理大小

### 4G+内存服务器
- 使用高性能配置
- 启用所有功能
- 较大的批处理大小

## 🎯 最佳实践

1. **选择合适的配置**: 根据服务器实际内存选择
2. **定期监控**: 使用监控工具检查内存使用
3. **及时调整**: 根据使用情况调整配置
4. **预防为主**: 在问题发生前进行调整
5. **文档记录**: 记录配置变更和原因
